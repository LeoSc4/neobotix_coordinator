<?xml version="1.0"?>
<root main_tree_to_execute="BehaviorTree">
    <!-- ////////// -->
    <BehaviorTree ID="BehaviorTree">
        <Sequence>
            <SubTree ID="GetCupFromStack" name="GetCupFromStack"/>
            <SubTree ID="PlaceCupToTable" name="PlaceCupToTable"/>
            <SubTree ID="GetCupFromStack" name="GetCupFromStack"/>
            <SubTree ID="PlaceCupToTable_5" name="PlaceCupToTable_5"/>
            <SubTree ID="GetCupFromStack" name="GetCupFromStack"/>
            <SubTree ID="PlaceCupToTable_4" name="PlaceCupToTable_4"/>
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="GetCupFromStack">
        <Sequence>
            <Action ID="SetVelocity" velocity_scaling="0.2"/>
            <Action ID="MoveURGripper" fun="1" pin="10" state="0"/>
            <!-- <Action ID="MoveURGripper" fun="1" pin="10" state="0"/> -->
            <!-- Mid/ Home Pose -->
            <Action ID="MoveArmToJoints" joint1="-1.55" joint2="-1.83" joint3="-0.89" joint4="-1.99" joint5="1.54" joint6="0"/>

            <!-- Zwischenpose -->
            <Action ID="MoveArmToJoints" joint1="0" joint2="-0.79" joint3="-2.36" joint4="-1.57" joint5="-1.57" joint6="-3.14"/>

            <!-- Approach cup pose -->
            <Action ID="MoveArmToJoints" joint1="1.15" joint2="-1.82" joint3="-2.36" joint4="-0.54" joint5="-1.57" joint6="-2.75"/>

            <Action ID="SetVelocity" velocity_scaling="0.05"/> 

            <!-- Move upwards to get cup -->
            <Action ID="MoveArmToPoseLin" q_w="1" q_x="0.0053" q_y="-0.00116636" q_z="-0.014" x="-0.262" y="-0.315" z="0.58"/>

            <!-- grip cup -->
            <Action ID="Wait" seconds="2"/>
            <Action ID="MoveURGripper" fun="1" pin="10" state="1"/>
            <Action ID="Wait" seconds="2"/>

            <!-- move down, pull cup from stack -->
            <Action ID="SetVelocity" velocity_scaling="0.1"/>
            <Action ID="MoveArmToPoseLin" q_w="1" q_x="0.0053" q_y="-0.00116636" q_z="-0.014" x="-0.262" y="-0.315" z="0.40"/>

            <!-- Exit cup pose -->
            <Action ID="MoveArmToPoseLin" q_w="1" q_x="0.0053" q_y="-0.00116636" q_z="-0.014" x="-0.35" y="-0.10" z="0.40"/>

            <!-- Zwischenpose -->
            <Action ID="SetVelocity" velocity_scaling="0.2"/>
            <Action ID="MoveArmToJoints" joint1="0" joint2="-0.79" joint3="-2.36" joint4="-1.57" joint5="-1.57" joint6="-3.14"/>

            <!-- Mid/ Home Pose -->
            <Action ID="MoveArmToJoints" joint1="-1.55" joint2="-1.83" joint3="-0.89" joint4="-1.99" joint5="1.54" joint6="0"/>
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="PlaceCupToTable">
        <Sequence>
            <Action ID="GetArucoPosition" aruco_id="1" q_w="{q_w}" q_x="{q_x}" q_y="{q_y}" q_z="{q_z}" x="{x}" y="{y}" z="{z}"/>
            <Action ID="GetTfMarkerToBase" aruco_id="1" base_frame="ur_base_link" max_seconds="5" q_w="{q_w}" q_x="{q_x}" q_y="{q_y}" q_z="{q_z}" x="{x}" y="{y}" z="{z}"/>
            <Action ID="PlaceCup" cup_id="6" q_w="{q_w}" q_x="{q_x}" q_y="{q_y}" q_z="{q_z}" x="{x}" y="{y}" z="{z}"/>
            <Action ID="MoveURGripper" fun="1" pin="10" state="0"/>
            <Action ID="MoveArmToJoints" joint1="-1.55" joint2="-1.83" joint3="-0.89" joint4="4.29" joint5="1.54" joint6="0"/>
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="PlaceCupToTable_5">
        <Sequence>
            <Action ID="GetArucoPosition" aruco_id="1" q_w="{q_w}" q_x="{q_x}" q_y="{q_y}" q_z="{q_z}" x="{x}" y="{y}" z="{z}"/>
            <Action ID="GetTfMarkerToBase" aruco_id="1" base_frame="ur_base_link" max_seconds="5" q_w="{q_w}" q_x="{q_x}" q_y="{q_y}" q_z="{q_z}" x="{x}" y="{y}" z="{z}"/>
            <Action ID="PlaceCup" cup_id="5" q_w="{q_w}" q_x="{q_x}" q_y="{q_y}" q_z="{q_z}" x="{x}" y="{y}" z="{z}"/>
            <Action ID="MoveURGripper" fun="1" pin="10" state="0"/>
            <Action ID="MoveArmToJoints" joint1="-1.55" joint2="-1.83" joint3="-0.89" joint4="4.29" joint5="1.54" joint6="0"/>
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="PlaceCupToTable_4">
        <Sequence>
            <Action ID="GetArucoPosition" aruco_id="1" q_w="{q_w}" q_x="{q_x}" q_y="{q_y}" q_z="{q_z}" x="{x}" y="{y}" z="{z}"/>
            <Action ID="GetTfMarkerToBase" aruco_id="1" base_frame="ur_base_link" max_seconds="5" q_w="{q_w}" q_x="{q_x}" q_y="{q_y}" q_z="{q_z}" x="{x}" y="{y}" z="{z}"/>
            <Action ID="PlaceCup" cup_id="4" q_w="{q_w}" q_x="{q_x}" q_y="{q_y}" q_z="{q_z}" x="{x}" y="{y}" z="{z}"/>
            <Action ID="MoveURGripper" fun="1" pin="10" state="0"/>
            <Action ID="MoveArmToJoints" joint1="-1.55" joint2="-1.83" joint3="-0.89" joint4="4.29" joint5="1.54" joint6="0"/>
        </Sequence>
    </BehaviorTree>

    <!-- ////////// -->
    <TreeNodesModel>
        <Action ID="GetArucoPosition">
            <input_port name="aruco_id" type="int"/>
            <output_port name="q_w" type="float"/>
            <output_port name="q_x" type="float"/>
            <output_port name="q_y" type="float"/>
            <output_port name="q_z" type="float"/>
            <output_port name="x" type="float"/>
            <output_port name="y" type="float"/>
            <output_port name="z" type="float"/>
        </Action>
        <Action ID="GetTfMarkerToBase">
            <input_port name="aruco_id" type="int"/>
            <input_port name="base_frame" type="std::string"/>
            <input_port name="max_seconds" type="int"/>
            <output_port name="q_w" type="float"/>
            <output_port name="q_x" type="float"/>
            <output_port name="q_y" type="float"/>
            <output_port name="q_z" type="float"/>
            <output_port name="x" type="float"/>
            <output_port name="y" type="float"/>
            <output_port name="z" type="float"/>
        </Action>
        <Action ID="MoveArmToJoints">
            <input_port name="joint1" type="float"/>
            <input_port name="joint2" type="float"/>
            <input_port name="joint3" type="float"/>
            <input_port name="joint4" type="float"/>
            <input_port name="joint5" type="float"/>
            <input_port name="joint6" type="float"/>
        </Action>
        <Action ID="MoveArmToPoseLin">
            <input_port name="q_w" type="float"/>
            <input_port name="q_x" type="float"/>
            <input_port name="q_y" type="float"/>
            <input_port name="q_z" type="float"/>
            <input_port name="x" type="float"/>
            <input_port name="y" type="float"/>
            <input_port name="z" type="float"/>
        </Action>
        <Action ID="MoveURGripper">
            <input_port name="fun" type="int"/>
            <input_port name="pin" type="int"/>
            <input_port name="state" type="float"/>
        </Action>
        <Action ID="PlaceCup">
            <input_port name="cup_id" type="int"/>
            <input_port name="q_w" type="float"/>
            <input_port name="q_x" type="float"/>
            <input_port name="q_y" type="float"/>
            <input_port name="q_z" type="float"/>
            <input_port name="x" type="float"/>
            <input_port name="y" type="float"/>
            <input_port name="z" type="float"/>
        </Action>
        <Action ID="SetVelocity">
            <input_port name="velocity_scaling" type="float"/>
        </Action>
        <SubTree ID="SubTree"/>
        <Action ID="Wait">
            <input_port name="seconds" type="int"/>
        </Action>
    </TreeNodesModel>
    <!-- ////////// -->
</root>
